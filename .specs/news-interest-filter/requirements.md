# Requirements Document

## Introduction

Добавление AI-агента для оценки интересности новостей перед публикацией в
Telegram-канал. Агент оценивает каждую новость по 5-балльной шкале и принимает
решение о публикации. Новости с оценкой 4+ публикуются в человечном, доступном
стиле с красивым оформлением ссылок.

## Glossary

- **Interest Score**: Оценка интересности новости по шкале от 1 до 5 баллов
- **Publication Threshold**: Минимальный балл для публикации (по умолчанию 4)
- **AI Evaluator**: Компонент, использующий Vercel AI SDK для оценки новости
- **AI Writer**: Компонент для переписывания новости в человечном стиле
- **ProcessableEntry**: Внутренний тип данных для обработки новости

## Requirements

### Requirement 1: Оценка интересности новости

**User Story:** Как владелец канала, я хочу, чтобы AI оценивал новости по
интересности, чтобы публиковать только действительно важные и интересные
материалы.

#### Acceptance Criteria

1. THE AI Evaluator SHALL принимать на вход `ProcessableEntry` и возвращать
   числовую оценку от 1 до 5
2. THE AI Evaluator SHALL использовать Vercel AI SDK (`npm:ai`) с моделью GPT
   для оценки
3. THE AI Evaluator SHALL оценивать по следующим критериям:
   - Актуальность и новизна информации
   - Практическая ценность для разработчиков
   - Уникальность контента
   - Масштаб влияния (сколько людей затронет)
4. THE AI Evaluator SHALL возвращать структурированный ответ с полями `score`
   (1-5) и `reason` (краткое обоснование)
5. THE AI Evaluator SHALL использовать structured output (JSON schema) для
   гарантии формата ответа

### Requirement 2: Фильтрация по порогу публикации

**User Story:** Как владелец канала, я хочу публиковать только новости с высокой
оценкой, чтобы поддерживать качество контента.

#### Acceptance Criteria

1. THE system SHALL публиковать только новости с оценкой >= 4 баллов
2. THE system SHALL логировать все отклонённые новости с указанием оценки и
   причины
3. THE system SHALL NOT публиковать новости с оценкой < 4 баллов
4. WHEN новость отклонена THEN system SHALL возвращать статус `skipped` с
   информацией об оценке

### Requirement 3: Человечный стиль написания

**User Story:** Как читатель канала, я хочу получать новости, написанные
интересно и доступно, как будто их пишет живой человек.

#### Acceptance Criteria

1. THE AI Writer SHALL переписывать одобренные новости в человечном стиле
2. THE AI Writer SHALL сохранять всю фактическую информацию из оригинала
3. THE AI Writer SHALL писать на русском языке
4. THE AI Writer SHALL использовать живой, разговорный тон без канцеляризмов
5. THE AI Writer SHALL добавлять эмодзи для акцентов там, где уместно
6. THE AI Writer SHALL НЕ добавлять личное мнение или домыслы

### Requirement 4: Оформление ссылок в Markdown

**User Story:** Как читатель, я хочу видеть аккуратно оформленные ссылки, а не
голые URL.

#### Acceptance Criteria

1. THE AI Writer SHALL форматировать все ссылки в формате `[текст](url)`
2. THE AI Writer SHALL использовать осмысленный текст для ссылок (не "тут",
   "здесь", "ссылка")
3. THE AI Writer SHALL сохранять ссылку на источник в конце поста
4. THE AI Writer SHALL NOT выводить голые URL без markdown-оформления

### Requirement 5: Интеграция в существующий pipeline

**User Story:** Как разработчик, я хочу, чтобы новая функциональность
интегрировалась в существующий код минимальными изменениями.

#### Acceptance Criteria

1. THE system SHALL добавить новый модуль `lib/evaluator.ts` для оценки
   интересности
2. THE system SHALL модифицировать `processEntry` в `lib/llm.ts` для двухэтапной
   обработки
3. THE system SHALL сохранить совместимость с существующими типами
   `ProcessableEntry`
4. THE system SHALL возвращать расширенный результат с полями `published`,
   `score`, `reason`
5. WHEN происходит ошибка оценки THEN system SHALL логировать ошибку и
   пропускать публикацию

### Requirement 6: Логирование решений

**User Story:** Как владелец канала, я хочу видеть почему определённые новости
были опубликованы или отклонены.

#### Acceptance Criteria

1. THE system SHALL логировать для каждой новости: title, score, reason,
   published/skipped
2. THE system SHALL возвращать в webhook response информацию о принятых решениях
3. THE system SHALL NOT логировать чувствительные данные (токены, секреты)
